import numpy as np
import os

from PIL import Image
from os import listdir

from extract_data_sector import extract_data
from extract_data_sector import pixel2img
from extract_data_sector import str2uint8
from extract_data_sector import get_data
from extract_data_sector import pixel2bin_img

option = 0
dex_path = r"E:\KU-Android\train\KU-Android-pre-train\dex"
dex_folder = listdir(dex_path)

#section_size = 0x68 #data
#section_offset = 0x6c #data
section_size = 0x60
section_offset = 0x64

for i in range(len(dex_folder)):
    count = 0
    dex_list = listdir(os.path.join(dex_path, dex_folder[i]))
    for j in range(len(dex_list)):
        f = open(os.path.join(dex_path, dex_folder[i], dex_list[j]), 'rb')

        data_size = extract_data(f, section_size)  # data section의 size를 가져옵니다
        data_off = extract_data(f, section_offset)  # data section의 offset을 가져옵니다.

        data = get_data(f, data_off, data_size, 'byte')  # offset으로부터 size만큼 가져옵니다.

        print("data_size = ", data_size)
        print("data_off = ", data_off)

        pixel = str2uint8(data)  # hex값을 int8형태로 가져옵니다.

        width = int(len(pixel) ** 0.5)
        ##
        if option is 0: # pixel -> img로 단순하게 바꿔줍니다. width * width을 넘어서는 잉여값은 제거합니다.
            img = pixel2img(pixel, width)
        elif option is 1:
            #임계값을 잡아줘야 하는데, 여기서는 최근접 이웃보간법이라서 임계값을 통계로 보고 잘라줘야합니다.
            cpoint = 50#여기선 임의로 50으로 잡아줌
            img = pixel2bin_img(pixel, width, cpoint)
        ##

        img.save(os.path.join(dex_path, dex_folder[i], str(count) + ".jpg"))
        print(pixel)
        count += 1





